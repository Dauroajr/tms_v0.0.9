{% extends 'base.html' %}
{% load static i18n l10n %}

{% block title %}{{ vehicle.plate }} - {% translate 'Vehicle Details' %} - TMS{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2>
        <i class="bi bi-truck"></i> {{ vehicle.brand.name }} {{ vehicle.model }}
      </h2>
      <p class="text-muted">
        {% translate "Plate" %}: <strong>{{ vehicle.plate }}</strong>
      </p>
    </div>
    <div class="col-md-4 text-end">
      <a href="{% url 'fleet:vehicle_list' %}" class="btn btn-outline-secondary me-2">
        <i class="bi bi-arrow-left"></i> {% translate "Back" %}
      </a>
      <a href="{% url 'fleet:vehicle_update' vehicle.pk %}" class="btn btn-primary">
        <i class="bi bi-pencil"></i> {% translate "Edit" %}
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Left Column - Main Information -->
    <div class="col-lg-8">
      <!-- Basic Information Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> {% translate "Basic Information" %}
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Type" %}</label>
              <p class="mb-0">
                <span class="badge bg-secondary">{{ vehicle.get_type_display }}</span>
              </p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Status" %}</label>
              <p class="mb-0">
                {% if vehicle.status == 'active' %}
                <span class="badge bg-success">{{ vehicle.get_status_display }}</span>
                {% elif vehicle.status == 'maintenance' %}
                <span class="badge bg-warning">{{ vehicle.get_status_display }}</span>
                {% elif vehicle.status == 'inactive' %}
                <span class="badge bg-secondary">{{ vehicle.get_status_display }}</span>
                {% else %}
                <span class="badge bg-danger">{{ vehicle.get_status_display }}</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Brand" %}</label>
              <p class="mb-0"><strong>{{ vehicle.brand.name }}</strong></p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Model" %}</label>
              <p class="mb-0"><strong>{{ vehicle.model }}</strong></p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Year" %}</label>
              <p class="mb-0">{{ vehicle.year }}</p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Color" %}</label>
              <p class="mb-0">{{ vehicle.get_color_display|default:"-" }}</p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Fuel Type" %}</label>
              <p class="mb-0">{{ vehicle.get_fuel_type_display }}</p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Current Km" %}</label>
              <p class="mb-0">{{ vehicle.current_km|localize }} km</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Specifications Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-gear"></i> {% translate "Specifications" %}
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Load Capacity" %}</label>
              <p class="mb-0">
                {% if vehicle.capacity_kg %}
                {{ vehicle.capacity_kg|localize }} kg
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Volume Capacity" %}</label>
              <p class="mb-0">
                {% if vehicle.capacity_m3 %}
                {{ vehicle.capacity_m3|localize }} mÂ³
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Chassis Number" %}</label>
              <p class="mb-0"><code>{{ vehicle.chassis_number }}</code></p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "RENAVAM" %}</label>
              <p class="mb-0"><code>{{ vehicle.renavam }}</code></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Purchase Information Card -->
      {% if vehicle.purchase_date or vehicle.purchase_value %}
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-cash-stack"></i> {% translate "Purchase Information" %}
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Purchase Date" %}</label>
              <p class="mb-0">{{ vehicle.purchase_date|date:"SHORT_DATE_FORMAT"|default:"-" }}</p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">{% translate "Purchase Value" %}</label>
              <p class="mb-0">
                {% if vehicle.purchase_value %}
                R$ {{ vehicle.purchase_value|localize }}
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Maintenance Status Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-tools"></i> {% translate "Maintenance Status" %}
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="text-muted small">{% translate "Current Km" %}</label>
              <p class="mb-0"><strong>{{ vehicle.current_km|localize }} km</strong></p>
            </div>
            <div class="col-md-4">
              <label class="text-muted small">{% translate "Last Maintenance" %}</label>
              <p class="mb-0">
                {% if vehicle.last_maintenance_km %}
                {{ vehicle.last_maintenance_km|localize }} km
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-4">
              <label class="text-muted small">{% translate "Next Maintenance" %}</label>
              <p class="mb-0">
                {% if vehicle.next_maintenance_km %}
                {{ vehicle.next_maintenance_km|localize }} km
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </p>
            </div>
          </div>

          {% if vehicle.needs_maintenance %}
          <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle"></i>
            {% translate "This vehicle requires maintenance!" %}
          </div>
          {% else %}
          <div class="alert alert-success mt-3 mb-0">
            <i class="bi bi-check-circle"></i>
            {% translate "Maintenance is up to date" %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Notes Card -->
      {% if vehicle.notes %}
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-journal-text"></i> {% translate "Notes" %}
          </h5>
        </div>
        <div class="card-body">
          <p class="mb-0">{{ vehicle.notes|linebreaks }}</p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Right Column - Related Information -->
    <div class="col-lg-4">
      <!-- Current Assignment Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-person"></i> {% translate "Current Assignment" %}
          </h5>
        </div>
        <div class="card-body">
          {% if current_assignment %}
          <div class="text-center">
            <i class="bi bi-person-circle display-4 text-primary"></i>
            <h6 class="mt-3 mb-1">{{ current_assignment.driver.full_name }}</h6>
            <p class="text-muted small mb-2">
              {% translate "Since" %}: {{ current_assignment.start_date|date:"SHORT_DATE_FORMAT" }}
            </p>
            <span class="badge bg-success">{% translate "Active" %}</span>
          </div>
          {% else %}
          <div class="text-center text-muted py-3">
            <i class="bi bi-person-x display-4"></i>
            <p class="mt-3 mb-0">{% translate "Not assigned" %}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Actions Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-lightning"></i> {% translate "Quick Actions" %}
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{% url 'fleet:vehicle_update' vehicle.pk %}" class="btn btn-outline-primary">
              <i class="bi bi-pencil"></i> {% translate "Edit Vehicle" %}
            </a>
            <button class="btn btn-outline-secondary" disabled>
              <i class="bi bi-file-earmark-text"></i> {% translate "Add Document" %}
            </button>
            <button class="btn btn-outline-secondary" disabled>
              <i class="bi bi-tools"></i> {% translate "Schedule Maintenance" %}
            </button>
            <button class="btn btn-outline-secondary" disabled>
              <i class="bi bi-person-plus"></i> {% translate "Assign Driver" %}
            </button>
            <a href="{% url 'fleet:vehicle_delete' vehicle.pk %}" class="btn btn-outline-danger">
              <i class="bi bi-trash"></i> {% translate "Delete Vehicle" %}
            </a>
          </div>
        </div>
      </div>

      <!-- Metadata Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-clock-history"></i> {% translate "Metadata" %}
          </h5>
        </div>
        <div class="card-body">
          <small class="text-muted d-block mb-2">
            <strong>{% translate "Created" %}:</strong><br>
            {{ vehicle.created_at|date:"SHORT_DATETIME_FORMAT" }}
          </small>
          <small class="text-muted d-block">
            <strong>{% translate "Last Updated" %}:</strong><br>
            {{ vehicle.updated_at|date:"SHORT_DATETIME_FORMAT" }}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Documents Section -->
  {% if documents %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-file-earmark-text"></i> {% translate "Documents" %}
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>{% translate "Type" %}</th>
                  <th>{% translate "Number" %}</th>
                  <th>{% translate "Issue Date" %}</th>
                  <th>{% translate "Expiry Date" %}</th>
                  <th>{% translate "Status" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for doc in documents %}
                <tr>
                  <td>{{ doc.get_document_type_display }}</td>
                  <td>{{ doc.document_number|default:"-" }}</td>
                  <td>{{ doc.issue_date|date:"SHORT_DATE_FORMAT" }}</td>
                  <td>{{ doc.expiry_date|date:"SHORT_DATE_FORMAT"|default:"-" }}</td>
                  <td>
                    {% if doc.is_valid %}
                    {% if doc.expires_soon %}
                    <span class="badge bg-warning">{% translate "Expires Soon" %}</span>
                    {% else %}
                    <span class="badge bg-success">{% translate "Valid" %}</span>
                    {% endif %}
                    {% else %}
                    <span class="badge bg-danger">{% translate "Expired" %}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Maintenance Records Section -->
  {% if maintenance_records %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-tools"></i> {% translate "Recent Maintenance Records" %}
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>{% translate "Type" %}</th>
                  <th>{% translate "Date" %}</th>
                  <th>{% translate "Odometer" %}</th>
                  <th>{% translate "Cost" %}</th>
                  <th>{% translate "Status" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for record in maintenance_records %}
                <tr>
                  <td>{{ record.get_maintenance_type_display }}</td>
                  <td>{{ record.scheduled_date|date:"SHORT_DATE_FORMAT" }}</td>
                  <td>{{ record.odometer_reading|localize }} km</td>
                  <td>
                    {% if record.cost %}
                    R$ {{ record.cost|localize }}
                    {% else %}
                    -
                    {% endif %}
                  </td>
                  <td>
                    {% if record.status == 'completed' %}
                    <span class="badge bg-success">{{ record.get_status_display }}</span>
                    {% elif record.status == 'in_progress' %}
                    <span class="badge bg-warning">{{ record.get_status_display }}</span>
                    {% elif record.status == 'scheduled' %}
                    <span class="badge bg-info">{{ record.get_status_display }}</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ record.get_status_display }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Assignment History Section -->
  {% if assignment_history %}
  <div class="row mt-4 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="bi bi-clock-history"></i> {% translate "Assignment History" %}
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>{% translate "Driver" %}</th>
                  <th>{% translate "Start Date" %}</th>
                  <th>{% translate "End Date" %}</th>
                  <th>{% translate "Status" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for assignment in assignment_history %}
                <tr>
                  <td>{{ assignment.driver.full_name }}</td>
                  <td>{{ assignment.start_date|date:"SHORT_DATE_FORMAT" }}</td>
                  <td>{{ assignment.end_date|date:"SHORT_DATE_FORMAT"|default:"-" }}</td>
                  <td>
                    {% if assignment.is_active %}
                    <span class="badge bg-success">{% translate "Active" %}</span>
                    {% else %}
                    <span class="badge bg-secondary">{% translate "Ended" %}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
